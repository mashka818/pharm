# API Документация - Система Кэшбека

## Обзор

Система кэшбека предназначена для начисления и управления бонусами клиентам на основе их покупок. Система интегрирована с ФНС для валидации чеков и автоматического расчета кэшбека согласно активным акциям.

## Основные возможности

- ✅ Автоматический расчет кэшбека на основе акций и товаров
- ✅ Сопоставление товаров из чека с товарами в базе данных
- ✅ Поддержка различных типов кэшбека (процент/фиксированная сумма)
- ✅ Учет условий акций (минимальная сумма, количество)
- ✅ История начислений с детализацией
- ✅ Отмена начислений администратором
- ✅ Статистика и аналитика

## Архитектура

### Основные компоненты

1. **CashbackService** - основная логика расчета и начисления кэшбека
2. **CashbackController** - API для управления кэшбеком
3. **Модели БД**:
   - `Cashback` - история начислений
   - `CashbackItem` - детализация по товарам
   - `Product` - товары с параметрами кэшбека
   - `Offer` - акции и промо-предложения

### Интеграция с ФНС

Система интегрирована с модулем ФНС для:
- Валидации чеков через API ФНС
- Автоматического начисления кэшбека после успешной валидации
- Предотвращения дублирования начислений

## API Endpoints

### Администрирование кэшбека

#### GET /cashback/history/today
Получение истории кэшбека за текущий день.

**Query Parameters:**
- `promotionId` (optional) - ID промоакции для фильтрации

**Response:**
```json
[
  {
    "id": 1,
    "amount": 50000,
    "status": "active",
    "reason": null,
    "createdAt": "2024-01-15T10:30:00Z",
    "cancelledAt": null,
    "customer": {
      "id": 123,
      "name": "Иван",
      "surname": "Петров",
      "email": "ivan@example.com"
    },
    "promotion": {
      "promotionId": "promo-1",
      "name": "Аптечная сеть №1"
    },
    "cancelledByAdmin": null,
    "items": [
      {
        "id": 1,
        "productName": "Аспирин 500мг",
        "productSku": "ASP500",
        "quantity": 2,
        "itemPrice": 15000,
        "totalPrice": 30000,
        "cashbackAmount": 15000,
        "cashbackType": "percent",
        "cashbackRate": 5,
        "product": {
          "id": 456,
          "name": "Аспирин 500мг",
          "sku": "ASP500"
        },
        "offer": {
          "id": 789,
          "profit": 5,
          "profitType": "from"
        }
      }
    ]
  }
]
```

#### PUT /cashback/{id}/cancel
Отмена начисления кэшбека.

**Path Parameters:**
- `id` - ID кэшбека

**Request Body:**
```json
{
  "reason": "Дублирующий чек"
}
```

**Response:**
```json
{
  "success": true,
  "refundedAmount": 50000,
  "message": "Кэшбек на сумму 50000 копеек успешно отменен"
}
```

#### GET /cashback/{id}
Получение детальной информации о кэшбеке.

**Path Parameters:**
- `id` - ID кэшбека

#### GET /cashback/stats/today
Получение статистики кэшбека за текущий день.

**Query Parameters:**
- `promotionId` (optional) - ID промоакции для фильтрации

**Response:**
```json
{
  "totalCashback": 500000,
  "totalTransactions": 25,
  "activeCashback": 480000,
  "cancelledCashback": 20000,
  "uniqueCustomers": 18,
  "topOffers": [
    {
      "offerId": 789,
      "totalCashback": 150000,
      "transactionCount": 8
    }
  ]
}
```

### Интеграция с ФНС

Система автоматически интегрируется с существующим ФНС модулем:

#### POST /fns/scan-qr
При сканировании QR кода чека автоматически:
1. Валидирует чек через ФНС
2. Рассчитывает кэшбек согласно активным акциям
3. Начисляет кэшбек при успешной валидации
4. Создает записи в истории кэшбека

## Логика расчета кэшбека

### Алгоритм сопоставления товаров

1. **Точное соответствие по SKU** - приоритетный способ
2. **Поиск по названию**:
   - Точное совпадение названий
   - Частичное совпадение (один содержит другой)
   - Схожесть по ключевым словам (минимум 60%)

### Приоритеты начисления

1. **Акционные предложения** - проверяются первыми, выбирается наиболее выгодное
2. **Фиксированный кэшбек товара** - если не подходит ни одна акция
3. **Условия акций** - проверяются ограничения по сумме/количеству

### Типы кэшбека

- **Процентный** - процент от стоимости товара
- **Фиксированный** - фиксированная сумма в копейках

## Безопасность и ограничения

### Авторизация
- Все endpoints требуют авторизации через Bearer Token
- Доступ к административным функциям только для ролей `ADMIN` и `COMPANY`

### Предотвращение дублирования
- Кэшбек начисляется только один раз для одного чека
- Проверка по уникальным параметрам чека (fn, fd, fp)
- Дневные лимиты на количество начислений

### Валидация отмены
- Проверка наличия достаточного количества бонусов у клиента
- Возможность отмены только активных начислений
- Логирование всех операций отмены

## Мониторинг и логирование

Система ведет подробные логи:
- Всех операций расчета кэшбека
- Начисления и отмены кэшбека
- Ошибок и исключений
- Статистики использования

## Примеры использования

### Типичный сценарий начисления кэшбека

1. Клиент покупает товары в аптеке
2. Сканирует QR код чека в мобильном приложении
3. Система валидирует чек через ФНС
4. Рассчитывает кэшбек согласно активным акциям:
   - Аспирин по акции "5% кэшбек" = 1500 коп
   - Витамины без акции, фиксированный кэшбек = 500 коп
5. Начисляет общий кэшбек 2000 коп на счет клиента
6. Создает запись в истории для возможности отмены

### Отмена кэшбека администратором

1. Администратор видит подозрительное начисление
2. Переходит в раздел истории кэшбека
3. Находит нужное начисление и отменяет его
4. Указывает причину отмены
5. Система списывает бонусы у клиента
6. Обновляет статус начисления на "отменено"

## Технические требования

- NestJS 10+
- Prisma ORM
- PostgreSQL
- TypeScript
- Swagger для документации API

## Структура базы данных

### Таблица cashbacks
- Основная информация о начислении
- Связи с клиентом, промоакцией, чеком
- Статус и причина отмены
- Информация об администраторе, отменившем кэшбек

### Таблица cashback_items
- Детализация кэшбека по товарам
- Связи с товарами и акциями
- Параметры расчета кэшбека
- Данные о товаре из чека