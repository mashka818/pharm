# –õ–æ–≥–∏–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —á–µ–∫–æ–≤ –∏ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –∫–µ—à–±–µ–∫–∞

## –û–±–∑–æ—Ä

–°–∏—Å—Ç–µ–º–∞ —Ä–µ–∞–ª–∏–∑—É–µ—Ç –ø–æ–ª–Ω—ã–π flow —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è QR-–∫–æ–¥–æ–≤ —á–µ–∫–æ–≤, –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏—Ö —á–µ—Ä–µ–∑ –§–ù–° –∏ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –∫–µ—à–±–µ–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º. –ö–µ—à–±–µ–∫ –Ω–∞—á–∏—Å–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∑–∞ —Ç–æ–≤–∞—Ä—ã, —É—á–∞—Å—Ç–≤—É—é—â–∏–µ –≤ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞–∫—Ü–∏—è—Ö –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Å–µ—Ç–∏ –∞–ø—Ç–µ–∫.

## –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —Å—Ü–µ–Ω–∞—Ä–∏–π

1. **–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –≤ —Å–∏—Å—Ç–µ–º–µ –Ω–∞ –ø–æ–¥–¥–æ–º–µ–Ω–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Å–µ—Ç–∏
2. **–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ–∫–∞**: –û—Ç–ø—Ä–∞–≤–∫–∞ QR-–¥–∞–Ω–Ω—ã—Ö —á–µ–∫–∞ —á–µ—Ä–µ–∑ API
3. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –§–ù–°**: –ß–µ–∫ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –§–ù–° –Ω–∞ –ø–æ–¥–ª–∏–Ω–Ω–æ—Å—Ç—å
4. **–í–∞–ª–∏–¥–∞—Ü–∏—è**: –°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ —á–µ–∫ –Ω–µ –≤–æ–∑–≤—Ä–∞—Ç–Ω—ã–π –∏ –Ω–µ –ø–æ–¥–¥–µ–ª—å–Ω—ã–π
5. **–†–∞—Å—á–µ—Ç –∫–µ—à–±–µ–∫–∞**: –î–ª—è –≤–∞–ª–∏–¥–Ω—ã—Ö —á–µ–∫–æ–≤ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∫–µ—à–±–µ–∫ –∑–∞ –∞–∫—Ü–∏–æ–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã
6. **–ù–∞—á–∏—Å–ª–µ–Ω–∏–µ**: –ö–µ—à–±–µ–∫ –Ω–∞—á–∏—Å–ª—è–µ—Ç—Å—è –Ω–∞ –∞–∫–∫–∞—É–Ω—Ç –∏ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –≤ –∏—Å—Ç–æ—Ä–∏—é
7. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —á–µ–∫–∞**: –ß–µ–∫ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –∏—Å—Ç–æ—Ä–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

## –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### 1. FnsController (`/fns/scan-qr`)
- –ü—Ä–∏–Ω–∏–º–∞–µ—Ç QR-–¥–∞–Ω–Ω—ã–µ —á–µ–∫–∞
- –ò–∑–≤–ª–µ–∫–∞–µ—Ç ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø—Ä–æ–º–æ–∞–∫—Ü–∏–∏ –∏–∑ —Ç–æ–∫–µ–Ω–∞
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –¥–æ–º–µ–Ω–∞

### 2. FnsCashbackService
- **–ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è**: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ fn, fd, fp –¥–ª—è –≤—Å–µ—Ö —Å–µ—Ç–µ–π
- **–õ–∏–º–∏—Ç—ã**: –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –∏ –ø–æ—á–∞—Å–æ–≤—ã–µ –ª–∏–º–∏—Ç—ã –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–µ–∫–æ–≤
- **–ú–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–æ**: –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

### 3. FnsCheckService
- **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –§–ù–°**: SOAP –∑–∞–ø—Ä–æ—Å—ã –∫ API –§–ù–°
- **–í–∞–ª–∏–¥–∞—Ü–∏—è —á–µ–∫–æ–≤**: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤–æ–∑–≤—Ä–∞—Ç–Ω—ã—Ö –∏ –ø–æ–¥–¥–µ–ª—å–Ω—ã—Ö —á–µ–∫–æ–≤
- **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤**: –ü–∞—Ä—Å–∏–Ω–≥ –¥–∞–Ω–Ω—ã—Ö —á–µ–∫–∞ –∏–∑ –æ—Ç–≤–µ—Ç–∞ –§–ù–°

### 4. CashbackService
- **–†–∞—Å—á–µ—Ç –∫–µ—à–±–µ–∫–∞**: –¢–æ–ª—å–∫–æ –∑–∞ —Ç–æ–≤–∞—Ä—ã –≤ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞–∫—Ü–∏—è—Ö
- **–°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤**: –ê–ª–≥–æ—Ä–∏—Ç–º—ã –Ω–µ—á–µ—Ç–∫–æ–≥–æ –ø–æ–∏—Å–∫–∞ –ø–æ SKU –∏ –Ω–∞–∑–≤–∞–Ω–∏—é
- **–ò—Å—Ç–æ—Ä–∏—è –∫–µ—à–±–µ–∫–∞**: –î–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∑–∞–ø–∏—Å—å —Å —Ç–æ–≤–∞—Ä–∞–º–∏ –∏ –∞–∫—Ü–∏—è–º–∏

### 5. ReceiptService
- **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —á–µ–∫–æ–≤**: –ü–æ–ª–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —á–µ–∫–µ –∏ —Ç–æ–≤–∞—Ä–∞—Ö
- **–°–≤—è–∑–∏**: –ü—Ä–∏–≤—è–∑–∫–∞ –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, —Å–µ—Ç–∏ –∏ –∞–∫—Ü–∏—è–º

## –£–ª—É—á—à–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã

### üõ°Ô∏è –ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
```typescript
// –°—Ç—Ä–æ–≥–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ —á–µ–∫–∞
const globalExistingRequest = await this.prisma.fnsRequest.findFirst({
  where: {
    customerId,
    qrData: { path: ['fn'], equals: receiptData.fn },
    AND: [
      { qrData: { path: ['fd'], equals: receiptData.fd } },
      { qrData: { path: ['fp'], equals: receiptData.fp } }
    ],
    OR: [
      { cashbackAwarded: true },
      { status: 'success' },
      { status: 'pending' },
      { status: 'processing' }
    ]
  }
});
```

### üîç –í–∞–ª–∏–¥–∞—Ü–∏—è –≤–æ–∑–≤—Ä–∞—Ç–Ω—ã—Ö —á–µ–∫–æ–≤
```typescript
// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∏ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã—Ö —Å—É–º–º
const isReturnByType = operationType === 2 || operationType === '2';
const isReturnByName = receiptData.operationName?.toLowerCase().includes('–≤–æ–∑–≤—Ä–∞—Ç');
const isReturnByItems = receiptData.items?.some(item => item.price < 0);
const isReturn = isReturnByType || isReturnByName || isReturnByItems;
```

### üéØ –ö–µ—à–±–µ–∫ —Ç–æ–ª—å–∫–æ –∑–∞ –∞–∫—Ü–∏–æ–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã
```typescript
// –£–±—Ä–∞–Ω–∞ –ª–æ–≥–∏–∫–∞ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–µ—à–±–µ–∫–∞ –¥–ª—è –Ω–µ–∞–∫—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤
for (const offer of activeOffers) {
  const matchResult = await this.tryMatchItemWithOffer(receiptItem, offer);
  if (matchResult && matchResult.cashbackAmount > bestCashback) {
    bestCashback = matchResult.cashbackAmount;
    bestMatch = matchResult;
  }
}
// –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ç–æ–≤–∞—Ä —É—á–∞—Å—Ç–≤—É–µ—Ç –≤ –∞–∫—Ü–∏–∏ - –Ω–∞—á–∏—Å–ª—è–µ—Ç—Å—è –∫–µ—à–±–µ–∫
```

### üìä –î–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è
- **–ö–µ—à–±–µ–∫**: –¢–∞–±–ª–∏—Ü–∞ `Cashback` —Å –æ–±—â–µ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
- **–î–µ—Ç–∞–ª–∏**: –¢–∞–±–ª–∏—Ü–∞ `CashbackItem` —Å —Ä–∞–∑–±–∏–≤–∫–æ–π –ø–æ —Ç–æ–≤–∞—Ä–∞–º
- **–°–≤—è–∑–∏**: –ü–æ–ª–Ω–∞—è —Ç—Ä–∞—Å—Å–∏—Ä—É–µ–º–æ—Å—Ç—å –æ—Ç —á–µ–∫–∞ –¥–æ –∞–∫—Ü–∏–∏

## API Endpoints

### –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ–∫–∞
```http
POST /fns/scan-qr
Headers: Authorization, Host
Body: { fn, fd, fp, sum, date, typeOperation }
Response: { requestId, status, message, network }
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
```http
GET /fns/status/:requestId
Response: { requestId, status, isValid, isReturn, isFake, cashbackAmount, cashbackAwarded }
```

### –ò—Å—Ç–æ—Ä–∏—è –∫–µ—à–±–µ–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞
```http
GET /cashback/customer/history?promotionId=...
Response: { cashbacks[], statistics }
```

### –î–µ—Ç–∞–ª–∏ –∫–µ—à–±–µ–∫–∞
```http
GET /cashback/details/:cashbackId
Response: { cashback details with items and offers }
```

## –õ–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- ‚úÖ –£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å —á–µ–∫–∞ –ø–æ fn+fd+fp
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –≤–æ–∑–≤—Ä–∞—Ç–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
- ‚úÖ –õ–∏–º–∏—Ç—ã –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤
- ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç –º–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–∞

### 2. –í–∞–ª–∏–¥–∞—Ü–∏—è –§–ù–°
- ‚úÖ SOAP –∑–∞–ø—Ä–æ—Å—ã –∫ openapi.nalog.ru
- ‚úÖ –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ–¥–¥–µ–ª—å–Ω—ã—Ö —á–µ–∫–æ–≤
- ‚úÖ –ü–∞—Ä—Å–∏–Ω–≥ –¥–∞–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤

### 3. –†–∞—Å—á–µ—Ç –∫–µ—à–±–µ–∫–∞
- ‚úÖ –¢–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ –∞–∫—Ü–∏–∏ –Ω–∞ –¥–∞—Ç—É —á–µ–∫–∞
- ‚úÖ –°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ SKU –∏ –Ω–∞–∑–≤–∞–Ω–∏—é
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ª–æ–≤–∏–π –∞–∫—Ü–∏–π
- ‚úÖ –í—ã–±–æ—Ä –Ω–∞–∏–±–æ–ª–µ–µ –≤—ã–≥–æ–¥–Ω–æ–π –∞–∫—Ü–∏–∏

### 4. –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
- ‚úÖ –ê—Ç–æ–º–∞—Ä–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –∫–ª–∏–µ–Ω—Ç–∞
- ‚úÖ –î–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è
- ‚úÖ –°–≤—è–∑—å —Å —á–µ–∫–æ–º –∏ —Ç–æ–≤–∞—Ä–∞–º–∏

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è flow –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–∫—Ä–∏–ø—Ç `test-cashback-flow.js`:

```bash
node test-cashback-flow.js
```

–°–∫—Ä–∏–ø—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:
1. –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é
2. –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ QR –∫–æ–¥–∞
3. –°—Ç–∞—Ç—É—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏
4. –ü–æ–ª—É—á–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏
5. –ó–∞—â–∏—Ç—É –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–°–∏—Å—Ç–µ–º–∞ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –ø–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –≤—Å–µ—Ö —ç—Ç–∞–ø–∞—Ö:
- üìù –£—Ä–æ–≤–µ–Ω—å DEBUG –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–π –æ—Ç–ª–∞–¥–∫–∏
- üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø—Ä–æ–º–æ–∞–∫—Ü–∏—è–º
- ‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
- ‚ùå –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ø–ª–∞—Ç–µ–∂–Ω—ã–º–∏ —Å–∏—Å—Ç–µ–º–∞–º–∏

–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å —Ä–æ—Å—Å–∏–π—Å–∫–∏–º–∏ –ø–ª–∞—Ç–µ–∂–Ω—ã–º–∏ —Å–∏—Å—Ç–µ–º–∞–º–∏:
- –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ä–æ—Å—Å–∏–π—Å–∫–∏–µ —Ñ–æ—Ä–º–∞—Ç—ã
- –°—É–º–º—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –∫–æ–ø–µ–π–∫–∞—Ö
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ç–∏–ø–æ–≤ –≤—ã–≤–æ–¥–∞ —Å—Ä–µ–¥—Å—Ç–≤
- –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º –§–ó-54

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- üîê JWT —Ç–æ–∫–µ–Ω—ã –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
- üõ°Ô∏è –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Å–µ—Ö –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- üö´ –ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –º–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–∞
- üìù –ê—É–¥–∏—Ç –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- üîí –ö–æ–Ω—Ç—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø–∞ –ø–æ —Ä–æ–ª—è–º