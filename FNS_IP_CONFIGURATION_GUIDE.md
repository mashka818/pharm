# Руководство по настройке IP адресов для ФНС API

## Проблема
При запросах к ФНС API возникает ошибка:
```
Доступ к сервису для переданного IP, запрещен
```

## Причина
ФНС имеет систему контроля доступа по IP адресам. Только зарегистрированные IP адреса могут обращаться к API.

## Решение

### 1. Проверка текущего IP адреса сервера
```bash
# На сервере выполните команду для получения публичного IP:
curl ifconfig.me
# или
wget -qO- http://ipecho.net/plain
```

### 2. Проверка настроек в .env файле
Убедитесь, что в файле `.env` указан правильный IP адрес:
```env
PROD_SERVER_IP="91.236.198.205"
```

### 3. Обращение в ФНС для добавления IP
Если текущий IP сервера отличается от зарегистрированного в ФНС, необходимо:

1. **Обратиться в службу технической поддержки ФНС:**
   - URL: https://www.gnivc.ru/technical_support/
   - Указать AppId: `2dbfa911-1931-48e7-802f-640dc64429b0`
   - Указать текущий IP адрес сервера
   - Указать причину изменения IP

2. **Отправить письмо на email техподдержки:**
   ```
   Тема: Добавление IP адреса для доступа к OpenAPI
   
   Здравствуйте!
   
   Просим добавить IP адрес [ВАШИ_IP] для доступа к OpenAPI ФНС.
   
   Данные приложения:
   - AppId: 2dbfa911-1931-48e7-802f-640dc64429b0
   - Юрлицо: ООО Фармвижн
   - ИНН: 5032364514
   - Brand: ЧекПоинт
   - Контактное лицо: a.leutin@pharm-vision.ru
   - Телефон: 7 (916) 777-85-51
   
   С уважением,
   [Ваше имя]
   ```

### 4. Временное решение для разработки
Если нужно быстро протестировать интеграцию, можно:

1. **Использовать DEV_TEMPORARY_TOKEN** (если доступен):
   ```env
   DEV_TEMPORARY_TOKEN="61260744d941410c894288602ed75f19"
   ```

2. **Настроить VPN или прокси** с зарегистрированным IP адресом

### 5. Мониторинг статуса запросов
Система автоматически обрабатывает ошибки IP блокировки:
- Логи содержат информацию о проблеме
- Запросы помечаются как failed с соответствующим сообщением
- При восстановлении доступа обработка возобновляется автоматически

## Проверка настроек

### Тест подключения к ФНС
```bash
# Тест доступности эндпоинта аутентификации
curl -X POST https://openapi.nalog.ru:8090/open-api/AuthService/0.1 \
  -H "Content-Type: text/xml;charset=UTF-8" \
  -H "SOAPAction: urn:GetMessageRequest" \
  -d '<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:ns="urn://x-artefacts-gnivc-ru/inplat/servin/OpenApiMessageConsumerService/types/1.0">
        <soapenv:Header/>
        <soapenv:Body>
          <ns:GetMessageRequest>
            <ns:Message>
              <tns:AuthRequest xmlns:tns="urn://x-artefacts-gnivc-ru/ais3/kkt/AuthService/types/1.0">
                <tns:AuthAppInfo>
                  <tns:MasterToken>ВАШ_ТОКЕН</tns:MasterToken>
                </tns:AuthAppInfo>
              </tns:AuthRequest>
            </ns:Message>
          </ns:GetMessageRequest>
        </soapenv:Body>
      </soapenv:Envelope>'
```

### Ожидаемые ответы
- **Успешный ответ**: Содержит `<Token>` и `<ExpireTime>`
- **Ошибка IP**: `Доступ к сервису для переданного IP, запрещен`
- **Ошибка токена**: `Доступ к сервису для token запрещен`

## Дополнительные настройки безопасности

### Firewall правила
Убедитесь, что исходящие подключения к ФНС разрешены:
```bash
# Разрешить исходящие подключения к ФНС
sudo ufw allow out 8090
sudo ufw allow out 443 to openapi.nalog.ru
```

### DNS настройки
Проверьте резолвинг домена ФНС:
```bash
nslookup openapi.nalog.ru
```

## Автоматическое восстановление
Система включает механизм автоматического восстановления:
- Переподключение после устранения проблем с IP
- Автоматическое обновление токенов
- Логирование всех операций для диагностики