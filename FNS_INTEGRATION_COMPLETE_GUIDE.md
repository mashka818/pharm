# Полное руководство по интеграции ФНС API для сканирования QR-кодов чеков

## Обзор

Реализована полноценная интеграция с ФНС API для сканирования QR-кодов чеков с поддержкой:
- Мультидоменной архитектуры для сетей аптек
- Изолированного кешбека по промоакциям  
- Автоматической обработки ошибок согласно документации ФНС
- Системы очередей для надежной обработки запросов

## Пользовательский сценарий

1. **Пользователь сканирует чек** на поддомене (например: `р-фарм.чекпоинт.рф`)
2. **Фронт отправляет** параметры QR + JWT токен (содержит ID пользователя и ID сети)
3. **Бек извлекает** ID пользователя и ID сети из токена
4. **Бек отправляет** чек в ФНС для валидации
5. **Чек валиден** → начисление кешбека | **Невалиден** → ошибка

## Архитектура решения

### 1. Структура API endpoints

```
POST /fns/scan-qr          # Основной эндпоинт для сканирования QR
GET  /fns/status/:id       # Получение статуса обработки
GET  /fns/queue/stats      # Статистика очереди
GET  /fns/daily-count      # Дневные лимиты запросов
GET  /fns/test/connection  # Тестирование подключения к ФНС
POST /fns/test/qr          # Тестирование QR обработки
```

### 2. Сервисы

- **FnsAuthService** - Аутентификация с ФНС API
- **FnsCheckService** - SOAP запросы для проверки чеков
- **FnsQueueService** - Управление очередью запросов
- **FnsCashbackService** - Расчет и начисление кешбека
- **FnsService** - Основной сервис координации

### 3. База данных

Модели поддерживают мультидоменную архитектуру:
- `FnsRequest` - запросы к ФНС с привязкой к промоакции
- `FnsToken` - кэш токенов аутентификации
- `Promotion` - промоакции/сети аптек
- `Receipt` - чеки с кешбеком по сетям

## Настройка окружения

### Переменные .env

```env
# ФНС API конфигурация
FTX_API_URL="https://openapi.nalog.ru:8090"
FTX_TOKEN="LFgDIA4yBZjW6h174iwVDcRoDHhjmpuFLtAX3kHPT9ctgggajk36aLJIzIcs2kZyKvTqLy4rSEHi7KOgY0fuNHKPbGCekDg9qjpin04K4ZyfolqtwDBZ6f6Isja3MMWe"
PROD_SERVER_IP="91.236.198.205"

# Для разработки
DEV_TEMPORARY_TOKEN="61260744d941410c894288602ed75f19"

# База данных
DATABASE_URL="postgresql://user:password@localhost:5432/pharm_vision"
```

### Данные сервиса ФНС

```
AppId: 2dbfa911-1931-48e7-802f-640dc64429b0
Юрлицо: ООО Фармвижн (ИНН: 5032364514)
Brand: ЧекПоинт
IP: 91.236.198.205
Лимит: 1000 запросов/день
Адрес: https://openapi.nalog.ru:8090
Токен действует до: 2026-03-27
```

## Использование API

### Сканирование QR кода

```javascript
// POST /fns/scan-qr
// Headers: 
//   Authorization: Bearer JWT_TOKEN
//   Host: р-фарм.чекпоинт.рф

{
  "fn": "9287440300090728",      // Фискальный номер
  "fd": "77133",                 // Фискальный документ  
  "fp": "1482926127",           // Фискальный признак
  "sum": 240000,                // Сумма в копейках
  "date": "2019-04-09T16:38:00", // Дата операции
  "typeOperation": 1            // 1-приход, 2-возврат
}
```

### Ответ

```javascript
{
  "requestId": "uuid-here",
  "status": "pending",           // pending, rejected
  "message": "Receipt verification started",
  "network": "Р-Фарм"          // Название сети
}
```

### Получение статуса

```javascript
// GET /fns/status/{requestId}

{
  "requestId": "uuid-here",
  "status": "success",          // pending, processing, success, rejected, failed
  "cashbackAmount": 120,        // В копейках
  "cashbackAwarded": true,
  "isValid": true,
  "isReturn": false,
  "isFake": false,
  "createdAt": "2025-01-01T10:00:00Z",
  "updatedAt": "2025-01-01T10:01:00Z"
}
```

## Тестирование интеграции

### 1. Проверка подключения

```bash
curl -X GET http://localhost:4000/fns/test/connection
```

Проверяет:
- Получение публичного IP сервера
- Аутентификацию с ФНС
- Доступность сервисных эндпоинтов

### 2. Тестирование QR обработки

```bash
curl -X POST http://localhost:4000/fns/test/qr
```

Отправляет тестовый QR из документации ФНС и отслеживает весь процесс.

## Решение проблем

### Ошибка: "Доступ к сервису для переданного IP, запрещен"

**Причина**: IP сервера не зарегистрирован в ФНС

**Решение**:
1. Получить текущий IP: `curl ifconfig.me`
2. Обратиться в техподдержку ФНС: https://www.gnivc.ru/technical_support/
3. Указать AppId и новый IP адрес

### Ошибка: "Доступ к сервису для token запрещен" 

**Причина**: Неверный или истекший токен

**Решение**:
1. Проверить `FTX_TOKEN` в .env
2. Убедиться что токен не истек (действует до 2026-03-27)
3. Проверить что используется правильный токен из данных сервиса

### Ошибка: Rate limiting (429)

**Причина**: Превышен лимит запросов

**Решение**: 
- Система автоматически обрабатывает и повторяет запросы
- Проверить дневной лимит: `GET /fns/daily-count`

## Система очередей

Автоматическая обработка:
- **Каждые 30 секунд** - обработка pending запросов
- **Каждые 5 минут** - обновление токенов
- **Каждый день** - очистка старых запросов

Состояния запросов:
- `pending` - ожидает обработки
- `processing` - отправлен в ФНС
- `success` - успешно обработан
- `rejected` - отклонен ФНС (невалидный чек)
- `failed` - ошибка обработки

## Мониторинг

### Логи системы
```bash
# Основные события
[FnsAuthService] Refreshing FNS token
[FnsService] Processing QR scan for customer X
[FnsCheckService] Successfully sent message, received ID: xxx

# Ошибки
[FnsAuthService] IP address not whitelisted
[FnsCheckService] Rate limiting error from FNS
```

### Метрики
- `GET /fns/queue/stats` - статистика очереди
- `GET /fns/daily-count` - использование дневного лимита

## Масштабирование

Система готова к росту нагрузки:
- Асинхронная обработка через очередь
- Кэширование токенов аутентификации
- Автоматическое управление лимитами
- Изолированные промоакции по доменам

## Безопасность

- Все токены хранятся в переменных окружения
- JWT токены содержат ID пользователя и сети
- Валидация доменов для каждой промоакции
- Ограничения по IP на стороне ФНС

## Техническая поддержка

При проблемах с ФНС API:
- **Email**: a.leutin@pharm-vision.ru  
- **Телефон**: 7 (916) 777-85-51
- **ФНС поддержка**: https://www.gnivc.ru/technical_support/