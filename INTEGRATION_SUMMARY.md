# üéâ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å API –§–ù–° - –ó–ê–í–ï–†–®–ï–ù–ê

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏

### 1. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –§–ù–°
- –ù–∞—Å—Ç—Ä–æ–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –º–∞—Å—Ç–µ—Ä-—Ç–æ–∫–µ–Ω –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è `FTX_TOKEN`
- –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
- –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º

### 2. ‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ HTTP –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã SOAP –∑–∞–ø—Ä–æ—Å–æ–≤
- –£–±—Ä–∞–Ω —É—Å—Ç–∞—Ä–µ–≤—à–∏–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ `FNS-OpenApi-UserToken` —Å–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ v2.0.6
- –ù–∞—Å—Ç—Ä–æ–µ–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ SOAP –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ —á–µ–∫–æ–≤
- –î–æ–±–∞–≤–ª–µ–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ `Content-Type` –∏ `SOAPAction`

### 3. ‚úÖ –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –ª–æ–≥–∏–∫–∏ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –∫–µ—à–±–µ–∫–∞
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á–µ—Ç –∫–µ—à–±–µ–∫–∞ –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–µ —á–µ–∫–∞
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–æ–≤ –Ω–∞ –ø–æ–≤—Ç–æ—Ä–Ω–æ–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –∫–µ—à–±–µ–∫–∞ –∑–∞ –æ–¥–∏–Ω —á–µ–∫
- –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–æ–Ω—É—Å–æ–≤ –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç –∫–ª–∏–µ–Ω—Ç–∞

### 4. ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ rate limiting
- –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ 429 (Rate Limiting) —Å –ø–æ–≤—Ç–æ—Ä–Ω—ã–º–∏ –ø–æ–ø—ã—Ç–∫–∞–º–∏
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ `MessageNotFoundFault` –∏ `AuthenticationFault`
- –ù–∞—Å—Ç—Ä–æ–µ–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –æ—á–µ—Ä–µ–¥–µ–π —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º –Ω–∞ 5 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–Ω–µ–≤–Ω–æ–≥–æ –ª–∏–º–∏—Ç–∞ –≤ 1000 –∑–∞–ø—Ä–æ—Å–æ–≤

### 5. ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ API endpoints –¥–ª—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
- `POST /receipt/parse-qr` - –ü–∞—Ä—Å–∏–Ω–≥ QR-–∫–æ–¥–∞ —á–µ–∫–∞
- `POST /receipt/verify` - –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ–∫–∞ —Å –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ–º –∫–µ—à–±–µ–∫–∞ (—Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π)
- `POST /receipt/verify/test` - –¢–µ—Å—Ç–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ–∫–∞ –±–µ–∑ –∫–µ—à–±–µ–∫–∞
- `GET /receipt/status/:requestId` - –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–ø—Ä–æ—Å–∞
- `GET /receipt/stats/queue` - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—á–µ—Ä–µ–¥–∏ –∑–∞–ø—Ä–æ—Å–æ–≤
- `GET /receipt/history/cashback` - –ò—Å—Ç–æ—Ä–∏—è –∫–µ—à–±–µ–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞

### 6. ‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
- –°–æ–∑–¥–∞–Ω —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç `test-fns-integration.js`
- –ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é API
- –ù–∞—Å—Ç—Ä–æ–µ–Ω—ã –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

## üõ†Ô∏è –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
```
FnsModule
‚îú‚îÄ‚îÄ FnsController (API endpoints)
‚îú‚îÄ‚îÄ FnsService (–æ—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞)
‚îú‚îÄ‚îÄ FnsAuthService (–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è)
‚îú‚îÄ‚îÄ FnsCheckService (–ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ–∫–æ–≤)
‚îú‚îÄ‚îÄ FnsQueueService (–æ—á–µ—Ä–µ–¥—å –∑–∞–ø—Ä–æ—Å–æ–≤)
‚îî‚îÄ‚îÄ FnsCashbackService (—Ä–∞—Å—á–µ—Ç –∫–µ—à–±–µ–∫–∞)
```

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
- `fns_requests` - –ó–∞–ø—Ä–æ—Å—ã –∫ –§–ù–° —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏
- `fns_tokens` - –ö—ç—à —Ç–æ–∫–µ–Ω–æ–≤ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
- `fns_daily_limits` - –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –¥–Ω–µ–≤–Ω—ã—Ö –ª–∏–º–∏—Ç–æ–≤

### Cron –∑–∞–¥–∞—á–∏
- –ö–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥: –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—á–µ—Ä–µ–¥–∏ –∑–∞–ø—Ä–æ—Å–æ–≤
- –ö–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç: –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤
- –ï–∂–µ–¥–Ω–µ–≤–Ω–æ: –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö

## üöÄ –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

### –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ .env
```env
FTX_TOKEN="LFgDIA4yBZjW6h174iwVDcRoDHhjmpuFLtAX3kHPT9ctgggajk36aLJIzIcs2kZyKvTqLy4rSEHi7KOgY0fuNHKPbGCekDg9qjpin04K4ZyfolqtwDBZ6f6Isja3MMWe"
FNS_APP_ID="2dbfa911-1931-48e7-802f-640dc64429b0"
FNS_AUTH_SERVICE_URL="https://openapi.nalog.ru:8090/open-api/AuthService/0.1"
FNS_ASYNC_SERVICE_URL="https://openapi.nalog.ru:8090/open-api/ais3/KktService/0.1"
FNS_DAILY_LIMIT=1000
```

### –ó–∞–ø—É—Å–∫
```bash
npm install
npx prisma generate
npm run start:dev
```

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
```bash
node test-fns-integration.js
```

## üì± –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–æ–º

### –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ

1. **–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ QR-–∫–æ–¥–∞** (–ø–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏)
2. **–ü–∞—Ä—Å–∏–Ω–≥ QR-–∫–æ–¥–∞**:
```javascript
const response = await fetch('/receipt/parse-qr', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ qrData: scannedQrString })
});
```

3. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ–∫–∞**:
```javascript
const response = await fetch('/receipt/verify', {
  method: 'POST',
  headers: { 
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${userToken}`
  },
  body: JSON.stringify(parsedReceiptData)
});
```

4. **–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞**:
```javascript
const statusResponse = await fetch(`/receipt/status/${requestId}`);
```

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç

‚úÖ **–ü–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å API –§–ù–°:**
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ª–∏–Ω–Ω–æ—Å—Ç–∏ —á–µ–∫–æ–≤
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –∫–µ—à–±–µ–∫–∞
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö –æ—à–∏–±–æ–∫ –∏ –ª–∏–º–∏—Ç–æ–≤
- API –¥–ª—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
- –°–∏—Å—Ç–µ–º–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

‚úÖ **–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º:**
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–µ API –§–ù–°
- –°–æ–±–ª—é–¥–∞–µ—Ç –≤—Å–µ –ª–∏–º–∏—Ç—ã –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—Å–µ —Ç–∏–ø—ã –æ—à–∏–±–æ–∫
- –ì–æ—Ç–æ–≤–æ –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

- **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è**: `FNS_INTEGRATION_README.md`
- **–ò–∑–º–µ–Ω–µ–Ω–∏—è**: `FNS_INTEGRATION_CHANGES.md`
- **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**: `test-fns-integration.js`
- **–¢–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫–∞ –§–ù–°**: https://www.gnivc.ru/technical_support/

---

üéâ **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å API –§–ù–° —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –∏ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!**