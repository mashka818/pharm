# üîÑ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è QR-–∫–æ–¥–æ–≤ –§–ù–° —Å —Å–µ—Ç—è–º–∏ –∞–ø—Ç–µ–∫

## üìã **–û–ø–∏—Å–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏**

–°–∏—Å—Ç–µ–º–∞ –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å QR-–∫–æ–¥—ã —á–µ–∫–æ–≤ –§–ù–° –¥–ª—è –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –∫–µ—à–±–µ–∫–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–µ—Ç–∏ –∞–ø—Ç–µ–∫. –ö–∞–∂–¥–∞—è —Å–µ—Ç—å –∏–º–µ–µ—Ç —Å–≤–æ–π –ø–æ–¥–¥–æ–º–µ–Ω –∏ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è –∫–µ—à–±–µ–∫–∞.

## üèóÔ∏è **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞**

### **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —Å—Ü–µ–Ω–∞—Ä–∏–π:**
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∫–∞–Ω–∏—Ä—É–µ—Ç QR-–∫–æ–¥ —á–µ–∫–∞ –Ω–∞ –ø–æ–¥–¥–æ–º–µ–Ω–µ —Å–µ—Ç–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `—Ä-—Ñ–∞—Ä–º.—á–µ–∫–ø–æ–∏–Ω—Ç.—Ä—Ñ`)
2. –§—Ä–æ–Ω—Ç–µ–Ω–¥ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç QR-–∫–æ–¥ + —Ç–æ–∫–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ –±—ç–∫–µ–Ω–¥
3. –ë—ç–∫–µ–Ω–¥ –∏–∑–≤–ª–µ–∫–∞–µ—Ç ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Å–µ—Ç—å –ø–æ –ø–æ–¥–¥–æ–º–µ–Ω—É
4. –ë—ç–∫–µ–Ω–¥ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ —á–µ–∫–∞ –≤ –§–ù–° –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
5. –ü—Ä–∏ –≤–∞–ª–∏–¥–Ω–æ–º —á–µ–∫–µ –Ω–∞—á–∏—Å–ª—è–µ—Ç—Å—è –∫–µ—à–±–µ–∫ —Å–æ–≥–ª–∞—Å–Ω–æ —É—Å–ª–æ–≤–∏—è–º —Å–µ—Ç–∏

## üîß **–ù–æ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã**

### **1. FnsQrController** (`src/fns/fns-qr.controller.ts`)
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ QR-–∫–æ–¥–æ–≤
- –ò–∑–≤–ª–µ–∫–∞–µ—Ç –ø–æ–¥–¥–æ–º–µ–Ω –∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞ Host
- –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç —Ç–æ–∫–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Å–µ—Ç—å –ø–æ –ø–æ–¥–¥–æ–º–µ–Ω—É

### **2. FnsQrParserService** (`src/fns/fns-qr-parser.service.ts`)
- –ü–∞—Ä—Å–∏—Ç QR-–∫–æ–¥ –≤ —Ñ–æ—Ä–º–∞—Ç–µ –§–ù–°
- –ò–∑–≤–ª–µ–∫–∞–µ—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã: fn, fd, fp, sum, date
- –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –¥–∞—Ç—É –≤ ISO —Ñ–æ—Ä–º–∞—Ç

### **3. FnsNetworkService** (`src/fns/fns-network.service.ts`)
- –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Å–µ—Ç—å –ø–æ –ø–æ–¥–¥–æ–º–µ–Ω—É
- –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –∫–µ—à–±–µ–∫ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Å–µ—Ç–∏
- –°–æ–ø–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Ç–æ–≤–∞—Ä—ã —Å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è–º–∏ —Å–µ—Ç–∏

### **4. ScanQrDto** (`src/fns/dto/scan-qr.dto.ts`)
- DTO –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è QR-–∫–æ–¥–∞
- –°–æ–¥–µ—Ä–∂–∏—Ç QR-–∫–æ–¥ –∏ —Ç–æ–∫–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

## üì° **API Endpoints**

### **POST /fns/qr/scan**
–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ QR-–∫–æ–¥–∞ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ —á–µ–∫–∞

**–ó–∞–≥–æ–ª–æ–≤–∫–∏:**
- `Host`: –ü–æ–¥–¥–æ–º–µ–Ω —Å–µ—Ç–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `—Ä-—Ñ–∞—Ä–º.—á–µ–∫–ø–æ–∏–Ω—Ç.—Ä—Ñ`)
- `Content-Type`: `application/json`

**–¢–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞:**
```json
{
  "qrCode": "t=20231201T1430&s=1234.56&fn=9287440300090728&i=12345&fp=1234567890&n=1",
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "additionalData": {}
}
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "requestId": "uuid",
  "status": "pending",
  "message": "Receipt verification started",
  "networkId": 1,
  "networkName": "–†-–§–∞—Ä–º"
}
```

## üóÑÔ∏è **–û–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö**

### **–ù–æ–≤—ã–µ –ø–æ–ª—è –≤ —Ç–∞–±–ª–∏—Ü–µ `companies`:**
- `name` (VARCHAR) - –ù–∞–∑–≤–∞–Ω–∏–µ —Å–µ—Ç–∏
- `subdomain` (VARCHAR, UNIQUE) - –ü–æ–¥–¥–æ–º–µ–Ω —Å–µ—Ç–∏
- `role` (enum) - –î–æ–±–∞–≤–ª–µ–Ω–æ –∑–Ω–∞—á–µ–Ω–∏–µ `PHARMACY_NETWORK`

### **SQL –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:**
```sql
-- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª–µ–π –¥–ª—è —Å–µ—Ç–µ–π –∞–ø—Ç–µ–∫
ALTER TABLE companies ADD COLUMN IF NOT EXISTS name VARCHAR(255);
ALTER TABLE companies ADD COLUMN IF NOT EXISTS subdomain VARCHAR(255) UNIQUE;

-- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ enum CompanyRole
ALTER TYPE "CompanyRole" ADD VALUE IF NOT EXISTS 'PHARMACY_NETWORK';

-- –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤
CREATE INDEX IF NOT EXISTS idx_companies_subdomain ON companies(subdomain);
CREATE INDEX IF NOT EXISTS idx_companies_role ON companies(role);
```

## üîê **–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è**

### **–¢–æ–∫–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:**
- –°–æ–¥–µ—Ä–∂–∏—Ç ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ ID —Å–µ—Ç–∏
- –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å–µ—Ç–∏ –≤ —Ç–æ–∫–µ–Ω–µ –∏ –ø–æ–¥–¥–æ–º–µ–Ω–∞

### **–ü–æ–¥–¥–æ–º–µ–Ω—ã:**
- –ò–∑–≤–ª–µ–∫–∞—é—Ç—Å—è –∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞ `Host`
- –§–æ—Ä–º–∞—Ç: `{subdomain}.{domain}`
- –ü—Ä–∏–º–µ—Ä: `—Ä-—Ñ–∞—Ä–º.—á–µ–∫–ø–æ–∏–Ω—Ç.—Ä—Ñ`

## üí∞ **–†–∞—Å—á–µ—Ç –∫–µ—à–±–µ–∫–∞**

### **–õ–æ–≥–∏–∫–∞ —Ä–∞—Å—á–µ—Ç–∞:**
1. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–µ—Ç–∏ –ø–æ –ø–æ–¥–¥–æ–º–µ–Ω—É
2. –ü–æ–ª—É—á–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –¥–ª—è —Å–µ—Ç–∏
3. –ü–∞—Ä—Å–∏–Ω–≥ —Ç–æ–≤–∞—Ä–æ–≤ –∏–∑ —á–µ–∫–∞
4. –°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤ —Å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è–º–∏
5. –†–∞—Å—á–µ—Ç –∫–µ—à–±–µ–∫–∞ –ø–æ —É—Å–ª–æ–≤–∏—è–º —Å–µ—Ç–∏

### **–¢–∏–ø—ã –∫–µ—à–±–µ–∫–∞:**
- **–ü—Ä–æ—Ü–µ–Ω—Ç–Ω—ã–π**: `itemTotal * (profit / 100)`
- **–§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π**: `profit`

## üöÄ **–†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ**

### **1. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:**
```bash
# –ü—Ä–∏–º–µ–Ω–∏—Ç—å SQL-–º–∏–≥—Ä–∞—Ü–∏—é
psql -d pharm_vision -f migration_add_network_subdomain.sql
```

### **2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è:**
```env
DATABASE_URL="postgresql://postgres:010406@localhost:5432/pharm_vision"
FNS_APP_ID="2dbfa911-1931-48e7-802f-640dc64429b0"
FNS_AUTH_SERVICE_URL="https://openapi.nalog.ru:8090/open-api/AuthService/0.1"
FNS_ASYNC_SERVICE_URL="https://openapi.nalog.ru:8090/open-api/ais3/KktService/0.1"
JWT_SECRET="gpW7DtMraBcCf4rXXyMmLZ25cMsrjv6z"
```

### **3. –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Ç–µ–π –∞–ø—Ç–µ–∫:**
```sql
INSERT INTO companies (username, password, name, subdomain, promotionId, role)
VALUES 
  ('r-pharm', 'hashed_password', '–†-–§–∞—Ä–º', '—Ä-—Ñ–∞—Ä–º', 'promotion_id', 'PHARMACY_NETWORK'),
  ('apteka-36-6', 'hashed_password', '–ê–ø—Ç–µ–∫–∞ 36.6', 'apteka-36-6', 'promotion_id', 'PHARMACY_NETWORK');
```

## üß™ **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**

### **–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞:**
```bash
curl -X POST http://localhost:4000/fns/qr/scan \
  -H "Host: —Ä-—Ñ–∞—Ä–º.—á–µ–∫–ø–æ–∏–Ω—Ç.—Ä—Ñ" \
  -H "Content-Type: application/json" \
  -d '{
    "qrCode": "t=20231201T1430&s=1234.56&fn=9287440300090728&i=12345&fp=1234567890&n=1",
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
  }'
```

### **–û–∂–∏–¥–∞–µ–º—ã–π –æ—Ç–≤–µ—Ç:**
```json
{
  "requestId": "550e8400-e29b-41d4-a716-446655440000",
  "status": "pending",
  "message": "Receipt verification started",
  "networkId": 1,
  "networkName": "–†-–§–∞—Ä–º"
}
```

## üìä **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**

### **–õ–æ–≥–∏:**
- –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è —Å —É—Ä–æ–≤–Ω–µ–º INFO
- –û—à–∏–±–∫–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è —Å —É—Ä–æ–≤–Ω–µ–º ERROR
- –í–∫–ª—é—á–∞—é—Ç ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —Å–µ—Ç–∏ –∏ –∑–∞–ø—Ä–æ—Å–∞

### **–ú–µ—Ç—Ä–∏–∫–∏:**
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö QR-–∫–æ–¥–æ–≤
- –£—Å–ø–µ—à–Ω–æ—Å—Ç—å –ø—Ä–æ–≤–µ—Ä–æ–∫ –§–ù–°
- –°—É–º–º—ã –Ω–∞—á–∏—Å–ª–µ–Ω–Ω–æ–≥–æ –∫–µ—à–±–µ–∫–∞ –ø–æ —Å–µ—Ç—è–º

## üîÑ **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫**

### **–û—Å–Ω–æ–≤–Ω—ã–µ –æ—à–∏–±–∫–∏:**
- `400 Bad Request`: –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç QR-–∫–æ–¥–∞ –∏–ª–∏ —Ç–æ–∫–µ–Ω–∞
- `401 Unauthorized`: –ù–µ–≤–µ—Ä–Ω—ã–π —Ç–æ–∫–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `404 Not Found`: –°–µ—Ç—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –¥–ª—è –ø–æ–¥–¥–æ–º–µ–Ω–∞

### **–õ–æ–≥–∏–∫–∞ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫:**
- Rate limiting: –ø–æ–≤—Ç–æ—Ä —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥
- –û—à–∏–±–∫–∏ —Å–µ—Ç–∏: –¥–æ 3 –ø–æ–ø—ã—Ç–æ–∫
- –¢–∞–π–º–∞—É—Ç—ã: 30 —Å–µ–∫—É–Ω–¥ –Ω–∞ –∑–∞–ø—Ä–æ—Å

## üéØ **–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É**

‚úÖ **–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:**
- –ü–∞—Ä—Å–∏–Ω–≥ QR-–∫–æ–¥–æ–≤ –§–ù–°
- –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–µ—Ç–µ–π –ø–æ –ø–æ–¥–¥–æ–º–µ–Ω–∞–º
- –†–∞—Å—á–µ—Ç –∫–µ—à–±–µ–∫–∞ –ø–æ —Å–µ—Ç—è–º
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å API –§–ù–°
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–π

üîÑ **–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:**
1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
2. –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö —Å–µ—Ç–µ–π –∞–ø—Ç–µ–∫
3. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ QR-–∫–æ–¥–∞–º–∏
4. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
5. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–ª–µ—Ä—Ç–æ–≤