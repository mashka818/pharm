# üßæ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å API –§–ù–°

## üìã –û–ø–∏—Å–∞–Ω–∏–µ

–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –§–µ–¥–µ—Ä–∞–ª—å–Ω–æ–π –Ω–∞–ª–æ–≥–æ–≤–æ–π —Å–ª—É–∂–±–æ–π (–§–ù–°) –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —á–µ–∫–æ–≤ –∏ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –∫–µ—à–±–µ–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞–º. –°–∏—Å—Ç–µ–º–∞ –ø–æ–∑–≤–æ–ª—è–µ—Ç:

- ‚úÖ –ü—Ä–æ–≤–µ—Ä—è—Ç—å –ø–æ–¥–ª–∏–Ω–Ω–æ—Å—Ç—å —á–µ–∫–æ–≤ —á–µ—Ä–µ–∑ API –§–ù–°
- üí∞ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞—á–∏—Å–ª—è—Ç—å –∫–µ—à–±–µ–∫ –∑–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã–µ –ø–æ–∫—É–ø–∫–∏
- üìä –û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏ –ª–∏–º–∏—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤
- üîÑ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –æ—á–µ—Ä–µ–¥—å –∑–∞–ø—Ä–æ—Å–æ–≤ —Å —É—á–µ—Ç–æ–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –§–ù–°

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ —Ñ–∞–π–ª–µ `.env` –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:

```env
# FNS Integration Settings
FTX_TOKEN="–≤–∞—à_–º–∞—Å—Ç–µ—Ä_—Ç–æ–∫–µ–Ω_—Ñ–Ω—Å"
FNS_APP_ID="–≤–∞—à_app_id"
FNS_AUTH_SERVICE_URL="https://openapi.nalog.ru:8090/open-api/AuthService/0.1"
FNS_ASYNC_SERVICE_URL="https://openapi.nalog.ru:8090/open-api/ais3/KktService/0.1"
FNS_DAILY_LIMIT=1000
```

### 2. –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞

```bash
npm install
npm run start:dev
```

### 3. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

```bash
node test-fns-integration.js
```

## üì° API Endpoints

### –ü–∞—Ä—Å–∏–Ω–≥ QR-–∫–æ–¥–∞

```http
POST /receipt/parse-qr
Content-Type: application/json

{
  "qrData": "t=20240101T1200&s=1500.00&fn=9287440300090728&i=12345&fp=1234567890&n=1"
}
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "success": true,
  "data": {
    "fn": "9287440300090728",
    "fd": "12345",
    "fp": "1234567890",
    "sum": "1500",
    "date": "2024-01-01T12:00:00",
    "typeOperation": "1"
  }
}
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ–∫–∞ (—Å –∫–µ—à–±–µ–∫–æ–º)

```http
POST /receipt/verify
Authorization: Bearer <jwt_token>
Content-Type: application/json

{
  "fn": "9287440300090728",
  "fd": "12345",
  "fp": "1234567890",
  "sum": "1500",
  "date": "2024-01-01T12:00:00"
}
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ–∫–∞ (—Ç–µ—Å—Ç–æ–≤–∞—è, –±–µ–∑ –∫–µ—à–±–µ–∫–∞)

```http
POST /receipt/verify/test
Content-Type: application/json

{
  "fn": "9287440300090728",
  "fd": "12345",
  "fp": "1234567890",
  "sum": "1500",
  "date": "2024-01-01T12:00:00"
}
```

### –°—Ç–∞—Ç—É—Å –∑–∞–ø—Ä–æ—Å–∞

```http
GET /receipt/status/{requestId}
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "requestId": "uuid",
  "status": "success",
  "cashbackAmount": 150,
  "cashbackAwarded": true,
  "isValid": true,
  "createdAt": "2024-01-01T12:00:00Z",
  "updatedAt": "2024-01-01T12:05:00Z"
}
```

### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—á–µ—Ä–µ–¥–∏

```http
GET /receipt/stats/queue
Authorization: Bearer <jwt_token>
```

### –ò—Å—Ç–æ—Ä–∏—è –∫–µ—à–±–µ–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞

```http
GET /receipt/history/cashback
Authorization: Bearer <jwt_token>
```

## üîÑ –ü—Ä–æ—Ü–µ—Å—Å —Ä–∞–±–æ—Ç—ã

1. **–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ QR-–∫–æ–¥–∞** –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ
2. **–ü–∞—Ä—Å–∏–Ω–≥ –¥–∞–Ω–Ω—ã—Ö** —á–µ–∫–∞ –∏–∑ QR-–∫–æ–¥–∞
3. **–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –æ—á–µ—Ä–µ–¥—å** –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤ –§–ù–°
4. **–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è** –≤ –§–ù–° —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –º–∞—Å—Ç–µ—Ä-—Ç–æ–∫–µ–Ω–∞
5. **–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞** –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É —á–µ–∫–∞
6. **–û–∂–∏–¥–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞** –æ—Ç –§–ù–°
7. **–†–∞—Å—á–µ—Ç –∫–µ—à–±–µ–∫–∞** –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–µ
8. **–ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–æ–Ω—É—Å–æ–≤** –∫–ª–∏–µ–Ω—Ç—É

## üìä –°—Ç–∞—Ç—É—Å—ã –∑–∞–ø—Ä–æ—Å–æ–≤

- `pending` - –ó–∞–ø—Ä–æ—Å –≤ –æ—á–µ—Ä–µ–¥–∏ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É
- `processing` - –ó–∞–ø—Ä–æ—Å –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –§–ù–°
- `success` - –ß–µ–∫ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω, –∫–µ—à–±–µ–∫ –Ω–∞—á–∏—Å–ª–µ–Ω
- `rejected` - –ß–µ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω
- `failed` - –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ

## ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

### –õ–∏–º–∏—Ç—ã –§–ù–°
- **–î–Ω–µ–≤–Ω–æ–π –ª–∏–º–∏—Ç**: 1000 –∑–∞–ø—Ä–æ—Å–æ–≤
- **–û–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤**: 5
- **–ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏**: 3 —Ä–∞–∑–∞
- **–ò–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É –ø–æ–ø—ã—Ç–∫–∞–º–∏**: 5 –º–∏–Ω—É—Ç

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- **Rate Limiting (429)**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥
- **MessageNotFoundFault**: –ß–µ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –§–ù–°
- **AuthenticationFault**: –û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞
- **HTTP 500**: –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º

## üõ†Ô∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–æ–¥—É–ª—è

```
src/fns/
‚îú‚îÄ‚îÄ fns.module.ts              # –û—Å–Ω–æ–≤–Ω–æ–π –º–æ–¥—É–ª—å
‚îú‚îÄ‚îÄ fns.controller.ts          # API –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä
‚îú‚îÄ‚îÄ fns.service.ts             # –û—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–∏—Å
‚îú‚îÄ‚îÄ fns-auth.service.ts        # –°–µ—Ä–≤–∏—Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
‚îú‚îÄ‚îÄ fns-check.service.ts       # –°–µ—Ä–≤–∏—Å –ø—Ä–æ–≤–µ—Ä–∫–∏ —á–µ–∫–æ–≤
‚îú‚îÄ‚îÄ fns-queue.service.ts       # –°–µ—Ä–≤–∏—Å –æ—á–µ—Ä–µ–¥–∏ –∑–∞–ø—Ä–æ—Å–æ–≤
‚îú‚îÄ‚îÄ fns-cashback.service.ts    # –°–µ—Ä–≤–∏—Å —Ä–∞—Å—á–µ—Ç–∞ –∫–µ—à–±–µ–∫–∞
‚îú‚îÄ‚îÄ dto/
‚îÇ   ‚îú‚îÄ‚îÄ verify-receipt.dto.ts  # DTO –¥–ª—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏
‚îÇ   ‚îú‚îÄ‚îÄ receipt-status.dto.ts  # DTO –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞
‚îÇ   ‚îî‚îÄ‚îÄ parse-qr.dto.ts        # DTO –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ QR
‚îî‚îÄ‚îÄ types/
    ‚îî‚îÄ‚îÄ fns-response.type.ts   # –¢–∏–ø—ã –æ—Ç–≤–µ—Ç–æ–≤ –§–ù–°
```

## üóÑÔ∏è –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

### –¢–∞–±–ª–∏—Ü–∞ `fns_requests`
–•—Ä–∞–Ω–∏—Ç –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã –∫ –§–ù–° —Å –∏—Ö —Å—Ç–∞—Ç—É—Å–∞–º–∏ –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏.

### –¢–∞–±–ª–∏—Ü–∞ `fns_tokens`
–ö—ç—à —Ç–æ–∫–µ–Ω–æ–≤ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –§–ù–°.

### –¢–∞–±–ª–∏—Ü–∞ `fns_daily_limits`
–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –¥–Ω–µ–≤–Ω—ã—Ö –ª–∏–º–∏—Ç–æ–≤ –∑–∞–ø—Ä–æ—Å–æ–≤.

## üîß –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### Cron –∑–∞–¥–∞—á–∏
- **–ö–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥**: –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—á–µ—Ä–µ–¥–∏ –∑–∞–ø—Ä–æ—Å–æ–≤
- **–ö–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç**: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
- **–ï–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ –ø–æ–ª–Ω–æ—á—å**: –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
–í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è —Å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–º–∏ —É—Ä–æ–≤–Ω—è–º–∏:
- `INFO`: –£—Å–ø–µ—à–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
- `WARN`: –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è (–ª–∏–º–∏—Ç—ã, –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏)
- `ERROR`: –û—à–∏–±–∫–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

## üö® Troubleshooting

### –û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
```
Error: FNS authentication failed
```
**–†–µ—à–µ–Ω–∏–µ**: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –º–∞—Å—Ç–µ—Ä-—Ç–æ–∫–µ–Ω–∞ –≤ `.env`

### –ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ –ª–∏–º–∏—Ç–∞
```
Error: Daily request limit exceeded
```
**–†–µ—à–µ–Ω–∏–µ**: –î–æ–∂–¥–∏—Ç–µ—Å—å —Å–ª–µ–¥—É—é—â–µ–≥–æ –¥–Ω—è –∏–ª–∏ —É–≤–µ–ª–∏—á—å—Ç–µ –ª–∏–º–∏—Ç

### –¢–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–∞
```
Error: Timeout waiting for FNS result
```
**–†–µ—à–µ–Ω–∏–µ**: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–∏—Å–æ–≤ –§–ù–°

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

- **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –§–ù–°**: –í —Ñ–∞–π–ª–∞—Ö `open-api.txt` –∏ `example-api.txt`
- **–¢–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫–∞ –§–ù–°**: https://www.gnivc.ru/technical_support/
- **–ò–∑–º–µ–Ω–µ–Ω–∏—è**: –°–º. `FNS_INTEGRATION_CHANGES.md`

## üéØ –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É

‚úÖ **–ß—Ç–æ –≥–æ—Ç–æ–≤–æ:**
- –ü–æ–ª–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å API –§–ù–°
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –æ—à–∏–±–æ–∫
- –°–∏—Å—Ç–µ–º–∞ –æ—á–µ—Ä–µ–¥–µ–π —Å –ª–∏–º–∏—Ç–∞–º–∏
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –∫–µ—à–±–µ–∫–∞
- API –¥–ª—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

üîÑ **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
- –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ª–æ–≥–æ–≤ –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ
- –†–µ–≥—É–ª—è—Ä–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∑–∞–ø—Ä–æ—Å–æ–≤
- –°–ª–µ–¥–∏—Ç–µ –∑–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏ API –§–ù–°