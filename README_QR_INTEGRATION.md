# üöÄ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è QR-–∫–æ–¥–æ–≤ –§–ù–° - –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∑–∞–ø—É—Å–∫—É

## üìã **–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ**

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø–æ–ª–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ QR-–∫–æ–¥–æ–≤ —á–µ–∫–æ–≤ –§–ù–° —Å —É—á–µ—Ç–æ–º —Å–µ—Ç–µ–π –∞–ø—Ç–µ–∫. –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Å–µ—Ç—å –ø–æ –ø–æ–¥–¥–æ–º–µ–Ω—É –∏ –Ω–∞—á–∏—Å–ª—è–µ—Ç –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –∫–µ—à–±–µ–∫.

## üèóÔ∏è **–ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ**

### ‚úÖ **–ù–æ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**
- `FnsQrController` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ QR-—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
- `FnsQrParserService` - –ø–∞—Ä—Å–∏–Ω–≥ QR-–∫–æ–¥–æ–≤ –§–ù–°
- `FnsNetworkService` - —Ä–∞–±–æ—Ç–∞ —Å —Å–µ—Ç—è–º–∏ –∞–ø—Ç–µ–∫
- `ScanQrDto` - DTO –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤

### ‚úÖ **–û–±–Ω–æ–≤–ª–µ–Ω–∏—è:**
- –°—Ö–µ–º–∞ –ë–î —Å –ø–æ–ª—è–º–∏ –¥–ª—è —Å–µ—Ç–µ–π
- –†–∞—Å—á–µ—Ç –∫–µ—à–±–µ–∫–∞ –ø–æ —Å–µ—Ç—è–º
- –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–æ–≤ –∏ –ø–æ–¥–¥–æ–º–µ–Ω–æ–≤
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

## üöÄ **–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç**

### **1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è**
```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
npm install

# –°–æ–∑–¥–∞–Ω–∏–µ .env —Ñ–∞–π–ª–∞ (—É–∂–µ —Å–æ–∑–¥–∞–Ω)
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ .env
```

### **2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö**
```bash
# –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é —Å—Ö–µ–º—ã
psql -d pharm_vision -f migration_add_network_subdomain.sql

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
psql -d pharm_vision -f init_test_data.sql
```

### **3. –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è**
```bash
# –†–µ–∂–∏–º —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
npm run start:dev

# –ò–ª–∏ –ø—Ä–æ–¥–∞–∫—à–µ–Ω
npm run start:prod
```

## üì° **API Endpoints**

### **POST /fns/qr/scan**
–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ QR-–∫–æ–¥–∞ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ —á–µ–∫–∞

**–ó–∞–≥–æ–ª–æ–≤–∫–∏:**
```
Host: —Ä-—Ñ–∞—Ä–º.—á–µ–∫–ø–æ–∏–Ω—Ç.—Ä—Ñ
Content-Type: application/json
```

**–¢–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞:**
```json
{
  "qrCode": "t=20231201T1430&s=1234.56&fn=9287440300090728&i=12345&fp=1234567890&n=1",
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "additionalData": {}
}
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "requestId": "550e8400-e29b-41d4-a716-446655440000",
  "status": "pending",
  "message": "Receipt verification started",
  "networkId": 1,
  "networkName": "–†-–§–∞—Ä–º"
}
```

## üß™ **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**

### **–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤:**
```bash
# –¢–µ—Å—Ç –ø–∞—Ä—Å–∏–Ω–≥–∞ QR-–∫–æ–¥–æ–≤
node test_qr_integration.js
```

### **–¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ:**
- **QR-–∫–æ–¥**: `t=20231201T1430&s=1234.56&fn=9287440300090728&i=12345&fp=1234567890&n=1`
- **–ü–æ–¥–¥–æ–º–µ–Ω—ã**: `—Ä-—Ñ–∞—Ä–º.—á–µ–∫–ø–æ–∏–Ω—Ç.—Ä—Ñ`, `apteka-36-6.—á–µ–∫–ø–æ–∏–Ω—Ç.—Ä—Ñ`
- **–¢–æ–∫–µ–Ω**: –°–æ–∑–¥–∞–π—Ç–µ JWT —Ç–æ–∫–µ–Ω —Å –ø–æ–ª—è–º–∏ `id`, `networkId`

## üîß **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è**

### **–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (.env):**
```env
DATABASE_URL="postgresql://postgres:010406@localhost:5432/pharm_vision"
FNS_APP_ID="2dbfa911-1931-48e7-802f-640dc64429b0"
FNS_AUTH_SERVICE_URL="https://openapi.nalog.ru:8090/open-api/AuthService/0.1"
FNS_ASYNC_SERVICE_URL="https://openapi.nalog.ru:8090/open-api/ais3/KktService/0.1"
JWT_SECRET="gpW7DtMraBcCf4rXXyMmLZ25cMsrjv6z"
```

### **–°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Ç–µ–π –∞–ø—Ç–µ–∫:**
```sql
INSERT INTO companies (username, password, name, subdomain, promotion_id, role)
VALUES 
  ('r-pharm', 'hashed_password', '–†-–§–∞—Ä–º', '—Ä-—Ñ–∞—Ä–º', 'promotion_id', 'PHARMACY_NETWORK'),
  ('apteka-36-6', 'hashed_password', '–ê–ø—Ç–µ–∫–∞ 36.6', 'apteka-36-6', 'promotion_id', 'PHARMACY_NETWORK');
```

## üîÑ **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —Å—Ü–µ–Ω–∞—Ä–∏–π**

### **1. –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ QR-–∫–æ–¥–∞**
```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí —Ä-—Ñ–∞—Ä–º.—á–µ–∫–ø–æ–∏–Ω—Ç.—Ä—Ñ ‚Üí –°–∫–∞–Ω–∏—Ä—É–µ—Ç QR-–∫–æ–¥
```

### **2. –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö**
```
–§—Ä–æ–Ω—Ç–µ–Ω–¥ ‚Üí POST /fns/qr/scan
{
  "qrCode": "t=20231201T1430&s=1234.56&fn=9287440300090728&i=12345&fp=1234567890&n=1",
  "token": "JWT_TOKEN"
}
```

### **3. –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞ –±—ç–∫–µ–Ω–¥–µ**
```
1. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –ø–æ–¥–¥–æ–º–µ–Ω–∞: —Ä-—Ñ–∞—Ä–º
2. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–µ—Ç–∏: –†-–§–∞—Ä–º
3. –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–∞
4. –ü–∞—Ä—Å–∏–Ω–≥ QR-–∫–æ–¥–∞
5. –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ –§–ù–°
6. –†–∞—Å—á–µ—Ç –∫–µ—à–±–µ–∫–∞
7. –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–æ–Ω—É—Å–æ–≤
```

### **4. –†–µ–∑—É–ª—å—Ç–∞—Ç**
```
{
  "requestId": "uuid",
  "status": "pending",
  "networkId": 1,
  "networkName": "–†-–§–∞—Ä–º"
}
```

## üìä **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**

### **–õ–æ–≥–∏:**
- –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è
- –£—Ä–æ–≤–Ω–∏: INFO, ERROR
- –í–∫–ª—é—á–∞—é—Ç ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —Å–µ—Ç–∏, –∑–∞–ø—Ä–æ—Å–∞

### **–ú–µ—Ç—Ä–∏–∫–∏:**
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ QR-—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–π
- –£—Å–ø–µ—à–Ω–æ—Å—Ç—å –ø—Ä–æ–≤–µ—Ä–æ–∫ –§–ù–°
- –°—É–º–º—ã –∫–µ—à–±–µ–∫–∞ –ø–æ —Å–µ—Ç—è–º

## üîê **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**

### **–í–∞–ª–∏–¥–∞—Ü–∏—è:**
- –§–æ—Ä–º–∞—Ç QR-–∫–æ–¥–∞ –§–ù–°
- JWT —Ç–æ–∫–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å–µ—Ç–∏ –∏ –ø–æ–¥–¥–æ–º–µ–Ω–∞
- –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ–∫–æ–≤

### **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:**
- –î–Ω–µ–≤–Ω–æ–π –ª–∏–º–∏—Ç: 1000 –∑–∞–ø—Ä–æ—Å–æ–≤
- Rate limiting: 5 –∑–∞–ø—Ä–æ—Å–æ–≤ –∑–∞ —Ä–∞–∑
- –¢–∞–π–º–∞—É—Ç—ã: 30 —Å–µ–∫—É–Ω–¥

## üö® **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫**

### **–û—Å–Ω–æ–≤–Ω—ã–µ –æ—à–∏–±–∫–∏:**
- `400` - –ù–µ–≤–µ—Ä–Ω—ã–π QR-–∫–æ–¥ –∏–ª–∏ —Ç–æ–∫–µ–Ω
- `401` - –ù–µ–≤–µ—Ä–Ω—ã–π —Ç–æ–∫–µ–Ω
- `404` - –°–µ—Ç—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞
- `429` - –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤

### **–ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏:**
- Rate limiting: 10 —Å–µ–∫—É–Ω–¥
- –û—à–∏–±–∫–∏ —Å–µ—Ç–∏: –¥–æ 3 –ø–æ–ø—ã—Ç–æ–∫
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤

## üìÅ **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤**

```
src/fns/
‚îú‚îÄ‚îÄ fns-qr.controller.ts      # –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä QR-—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
‚îú‚îÄ‚îÄ fns-qr-parser.service.ts  # –ü–∞—Ä—Å–∏–Ω–≥ QR-–∫–æ–¥–æ–≤
‚îú‚îÄ‚îÄ fns-network.service.ts    # –†–∞–±–æ—Ç–∞ —Å —Å–µ—Ç—è–º–∏
‚îú‚îÄ‚îÄ dto/
‚îÇ   ‚îî‚îÄ‚îÄ scan-qr.dto.ts       # DTO –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤
‚îî‚îÄ‚îÄ fns.module.ts            # –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –º–æ–¥—É–ª—å

migration_add_network_subdomain.sql  # –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î
init_test_data.sql                   # –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
test_qr_integration.js               # –¢–µ—Å—Ç—ã
FNS_QR_INTEGRATION.md               # –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
```

## üéØ **–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É**

### ‚úÖ **–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:**
- –ü–æ–ª–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å API –§–ù–°
- –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–µ—Ç–µ–π –ø–æ –ø–æ–¥–¥–æ–º–µ–Ω–∞–º
- –†–∞—Å—á–µ—Ç –∫–µ—à–±–µ–∫–∞ –ø–æ —É—Å–ª–æ–≤–∏—è–º —Å–µ—Ç–µ–π
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### üîÑ **–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:**
1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
2. –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∞–ª—å–Ω—ã—Ö —Å–µ—Ç–µ–π –∞–ø—Ç–µ–∫
3. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ QR-–∫–æ–¥–∞–º–∏
4. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
5. –î–µ–ø–ª–æ–π –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω

## üìû **–ü–æ–¥–¥–µ—Ä–∂–∫–∞**

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
2. –£–±–µ–¥–∏—Ç–µ—Å—å –≤ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ .env
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î
4. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ —Å `test_qr_integration.js`

---

**üéâ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!**