# –û—Ç–ª–∞–¥–∫–∞ –ø—Ä–æ–±–ª–µ–º —Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π –§–ù–°

## –ü—Ä–æ–±–ª–µ–º–∞

–ß–µ–∫ —Å –¥–∞–Ω–Ω—ã–º–∏:
```json
{
  "fn": "7380440801438274",
  "fd": "156960",
  "fp": "881863638",
  "sum": 120,
  "date": "2025-06-01T20:29:00",
  "typeOperation": 1,
  "additionalData": {}
}
```

–ü—Ä–æ—Ö–æ–¥–∏—Ç –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞ —Å–∞–π—Ç–µ –§–ù–°, –Ω–æ –æ—Ç–∫–ª–æ–Ω—è–µ—Ç—Å—è –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `rejected`.

## –í—ã—è–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. üóìÔ∏è –î–∞—Ç–∞ –≤ –±—É–¥—É—â–µ–º
**–ü—Ä–æ–±–ª–µ–º–∞**: –î–∞—Ç–∞ —á–µ–∫–∞ `2025-06-01` –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –±—É–¥—É—â–µ–º  
**–ü—Ä–∏—á–∏–Ω–∞**: –§–ù–° –æ—Ç–∫–ª–æ–Ω—è–µ—Ç —á–µ–∫–∏ —Å –¥–∞—Ç–∞–º–∏ –≤ –±—É–¥—É—â–µ–º  
**–†–µ—à–µ–Ω–∏–µ**: –ò—Å–ø—Ä–∞–≤–∏—Ç—å –¥–∞—Ç—É –Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é (–Ω–∞–ø—Ä–∏–º–µ—Ä, `2024-06-01` –∏–ª–∏ `2023-06-01`)

### 2. üí∞ –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Å—É–º–º—ã
**–ü—Ä–æ–±–ª–µ–º–∞**: –°—É–º–º–∞ `120` –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä–æ–≤–∞–Ω–∞  
**–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã**:
- –§–ù–° –æ–∂–∏–¥–∞–µ—Ç —Å—É–º–º—É –≤ –∫–æ–ø–µ–π–∫–∞—Ö
- 120 –∫–æ–ø–µ–µ–∫ = 1.20 —Ä—É–±–ª–µ–π (–æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∞—è —Å—É–º–º–∞)
- –í–æ–∑–º–æ–∂–Ω–æ, –∏–º–µ–ª–æ—Å—å –≤ –≤–∏–¥—É 120 —Ä—É–±–ª–µ–π = 12000 –∫–æ–ø–µ–µ–∫

**–†–µ—à–µ–Ω–∏–µ**: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å —Å—É–º–º—ã:
- –ï—Å–ª–∏ —á–µ–∫ –Ω–∞ 1.20 —Ä—É–± ‚Üí –æ—Å—Ç–∞–≤–∏—Ç—å `120`
- –ï—Å–ª–∏ —á–µ–∫ –Ω–∞ 120 —Ä—É–± ‚Üí –∏–∑–º–µ–Ω–∏—Ç—å –Ω–∞ `12000`

### 3. üîç –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
**–ü—Ä–æ–±–ª–µ–º–∞**: –ù–µ —Ö–≤–∞—Ç–∞–ª–æ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏  
**–†–µ—à–µ–Ω–∏–µ**: –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –≤—Å–µ—Ö —ç—Ç–∞–ø–∞—Ö

## –í–Ω–µ—Å–µ–Ω–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### 1. –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
```typescript
private formatQrDataForFns(qrData: any) {
  // –í–∞–ª–∏–¥–∞—Ü–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
  if (!qrData.fn || !qrData.fd || !qrData.fp || !qrData.sum || !qrData.date) {
    throw new Error('Missing required QR data fields');
  }

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞—Ç—ã –≤ –±—É–¥—É—â–µ–º
  const date = new Date(qrData.date);
  const oneDayFromNow = new Date(Date.now() + 24 * 60 * 60 * 1000);
  if (date > oneDayFromNow) {
    this.logger.warn(`Receipt date is in the future: ${qrData.date}`);
  }

  // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –§–ù–°
  return {
    fn: String(qrData.fn).trim(),
    fd: String(qrData.fd).trim(), 
    fp: String(qrData.fp).trim(),
    sum: parseInt(qrData.sum),
    date: date.toISOString().split('.')[0], // –£–±–∏—Ä–∞–µ–º –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥—ã
    typeOperation: qrData.typeOperation || 1
  };
}
```

### 2. –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ SOAP –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –æ—Ç–≤–µ—Ç–æ–≤
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —ç—Ç–∞–ø–æ–≤ –ø–∞—Ä—Å–∏–Ω–≥–∞

### 3. Debug endpoint
–î–æ–±–∞–≤–ª–µ–Ω —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π endpoint `/fns/debug-receipt` –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏:
```http
POST /fns/debug-receipt
Content-Type: application/json

{
  "fn": "7380440801438274",
  "fd": "156960", 
  "fp": "881863638",
  "sum": 120,
  "date": "2025-06-01T20:29:00",
  "typeOperation": 1
}
```

### 4. –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤ –§–ù–°
- –ü–æ–∏—Å–∫ –¥–∞–Ω–Ω—ã—Ö —á–µ–∫–∞ –≤ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–∞—Ö XML
- –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –æ—à–∏–±–æ–∫
- –£–ª—É—á—à–µ–Ω–Ω–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–∏—á–∏–Ω –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ó–∞–ø—É—Å–∫ debug endpoint
```bash
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ axios –µ—Å–ª–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
npm install axios

# –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç
node debug-receipt.js
```

### –†—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
```bash
curl -X POST http://localhost:3000/fns/debug-receipt \
  -H "Content-Type: application/json" \
  -d '{
    "fn": "7380440801438274",
    "fd": "156960",
    "fp": "881863638", 
    "sum": 120,
    "date": "2025-06-01T20:29:00",
    "typeOperation": 1
  }'
```

## –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ò—Å–ø—Ä–∞–≤–∏—Ç—å –¥–∞—Ç—É
```json
{
  "fn": "7380440801438274",
  "fd": "156960",
  "fp": "881863638",
  "sum": 120,
  "date": "2024-06-01T20:29:00",  // ‚Üê –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –¥–∞—Ç–∞
  "typeOperation": 1
}
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ò—Å–ø—Ä–∞–≤–∏—Ç—å –¥–∞—Ç—É –∏ —Å—É–º–º—É
```json
{
  "fn": "7380440801438274", 
  "fd": "156960",
  "fp": "881863638",
  "sum": 12000,                    // ‚Üê 120 —Ä—É–±–ª–µ–π –≤ –∫–æ–ø–µ–π–∫–∞—Ö
  "date": "2024-06-01T20:29:00",  // ‚Üê –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –¥–∞—Ç–∞
  "typeOperation": 1
}
```

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏

1. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤ –ª–æ–≥–∞—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è** - —Ç–µ–ø–µ—Ä—å –±—É–¥–µ—Ç –¥–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–∞–∂–¥–æ–º —ç—Ç–∞–ø–µ
2. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ debug endpoint** - –æ–Ω –ø–æ–∫–∞–∂–µ—Ç –≤—Å–µ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã
3. **–°—Ä–∞–≤–Ω–∏—Ç–µ —Å —Ä–∞–±–æ—á–∏–º–∏ —á–µ–∫–∞–º–∏** - –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö —É—Å–ø–µ—à–Ω—ã—Ö —á–µ–∫–æ–≤

## –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –§–ù–°

1. ‚úÖ **–î–∞—Ç–∞ –≤ –±—É–¥—É—â–µ–º** - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π
2. ‚úÖ **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö** - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
3. ‚úÖ **–û—à–∏–±–∫–∏ –≤ SOAP –∑–∞–ø—Ä–æ—Å–µ** - —É–ª—É—á—à–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
4. üîç **–ß–µ–∫ —É–∂–µ –∞–Ω–Ω—É–ª–∏—Ä–æ–≤–∞–Ω** - –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å —á–µ–∫–∞ –≤ –§–ù–°
5. üîç **–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –§–ù–°** - –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–±–æ–∏ —Å–µ—Ä–≤–∏—Å–∞

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

–ü–æ—Å–ª–µ –≤–Ω–µ—Å–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –æ—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ –ª–æ–≥–∏:
```bash
# –í Docker
docker logs -f your-app-container | grep "FNS"

# –õ–æ–∫–∞–ª—å–Ω–æ
npm run start:dev | grep "FNS"
```

–ò—â–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –ø—Ä–µ—Ñ–∏–∫—Å–∞–º–∏:
- `üîç DEBUG:` - –æ—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
- `FNS ProcessingStatus:` - —Å—Ç–∞—Ç—É—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏ –§–ù–°
- `Receipt rejected` - –ø—Ä–∏—á–∏–Ω—ã –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è
- `FNS returned error:` - –æ—à–∏–±–∫–∏ –æ—Ç –§–ù–°